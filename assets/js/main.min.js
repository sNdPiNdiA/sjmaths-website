const appThemes={purple:{primary:"#8e44ad","primary-dark":"#6c3483","primary-light":"#a569bd",secondary:"#e74c3c",accent:"#f39c12"},blue:{primary:"#2563eb","primary-dark":"#1e40af","primary-light":"#60a5fa",secondary:"#0ea5e9",accent:"#22c55e"},green:{primary:"#16a34a","primary-dark":"#166534","primary-light":"#4ade80",secondary:"#22c55e",accent:"#facc15"},orange:{primary:"#f97316","primary-dark":"#c2410c","primary-light":"#fdba74",secondary:"#ef4444",accent:"#f59e0b"}};function applyThemeVars(t){const e=appThemes[t];if(!e)return;const o=document.documentElement.style;Object.entries(e).forEach(([n,a])=>{o.setProperty(`--${n}`,a)})}window.setTheme=function(t){applyThemeVars(t),localStorage.setItem("sjmaths-theme",t)};const initDarkMode=()=>{if(localStorage.getItem("sjmaths-dark")==="on"){document.body.classList.add("dark-mode");const i=document.querySelector("#darkToggle i")||document.querySelector("#theme-toggle i");i&&(i.classList.remove("fa-moon"),i.classList.add("fa-sun"))}const e=i=>{const s=i.querySelector("i");if(!s)return;const d=document.body.classList.contains("dark-mode");s.className=d?"fas fa-sun":"fas fa-moon",i.classList.contains("floating-dark-btn")&&(i.style.background=d?"#ffffff":"#2c3e50",i.style.color=d?"#2c3e50":"#ffffff")};document.addEventListener("click",i=>{const s=i.target.closest("#darkToggle, #theme-toggle");if(!s)return;const d=document.body.classList.toggle("dark-mode");localStorage.setItem("sjmaths-dark",d?"on":"off"),e(s)});const o=()=>{let i=document.getElementById("darkToggle");i&&!i.classList.contains("floating-dark-btn")&&(i.remove(),i=null),i||(i=document.createElement("button"),i.id="darkToggle",i.className="floating-dark-btn",i.innerHTML='<i class="fas fa-moon"></i>',i.setAttribute("aria-label","Toggle Dark Mode"),Object.assign(i.style,{position:"fixed",bottom:"20px",left:"20px",width:"50px",height:"50px",borderRadius:"50%",border:"none",boxShadow:"0 4px 15px rgba(0,0,0,0.3)",zIndex:"9999",cursor:"pointer",display:"flex",alignItems:"center",justifyContent:"center",fontSize:"1.2rem",transition:"all 0.3s ease"}),document.body.appendChild(i)),e(i)};o();const n=new MutationObserver(()=>{const i=document.querySelectorAll("#darkToggle");i.length>1?i.forEach(s=>{s.classList.contains("floating-dark-btn")||s.remove()}):i.length===0&&o()}),a=document.getElementById("header-container")||document.querySelector("header");a&&n.observe(a,{childList:!0,subtree:!0})},initScrollAnimations=()=>{if(!("IntersectionObserver"in window)){document.querySelectorAll(".animate-on-scroll").forEach(n=>n.classList.add("is-visible"));return}const t={threshold:.1,rootMargin:"0px 0px -20px 0px"},e=new IntersectionObserver(n=>{n.forEach(a=>{a.isIntersecting&&(a.target.classList.add("is-visible"),e.unobserve(a.target))})},t);document.querySelectorAll(".animate-on-scroll").forEach(n=>e.observe(n)),setTimeout(()=>{document.querySelectorAll(".animate-on-scroll:not(.is-visible)").forEach(a=>a.classList.add("is-visible"))},1e3)},initParallax=()=>{if(window.innerWidth<768||window.matchMedia("(prefers-reduced-motion: reduce)").matches)return;const t=document.querySelectorAll(".blob");if(!t.length)return;let e=!1;window.addEventListener("scroll",()=>{e||(window.requestAnimationFrame(()=>{const o=window.scrollY;t.forEach((n,a)=>{const i=(a+1)*.15;n.style.transform=`translateY(${o*i}px)`}),e=!1}),e=!0)})},initHeroSlider=()=>{const t=document.getElementById("heroCarousel"),e=document.querySelectorAll(".indicator"),o=document.querySelectorAll(".carousel-slide"),n=document.getElementById("heroPrev"),a=document.getElementById("heroNext");if(!t||!o.length)return;let i=0,s;const d=r=>{o.forEach(f=>f.classList.remove("active")),o[r].classList.add("active"),p(r),i=r},p=r=>{e.forEach((f,x)=>{f.classList.toggle("active",x===r)})},l=()=>{c(),s=setInterval(()=>{const r=(i+1)%o.length;d(r)},4e3)},c=()=>clearInterval(s);let u=0,h=0;const b=()=>{if(u-h>50){const r=(i+1)%o.length;d(r)}if(h-u>50){const r=(i-1+o.length)%o.length;d(r)}},m=document.querySelector(".hero");m&&(m.addEventListener("mouseenter",c),m.addEventListener("mouseleave",l),m.addEventListener("touchstart",r=>{c(),u=r.changedTouches[0].screenX},{passive:!0}),m.addEventListener("touchend",r=>{h=r.changedTouches[0].screenX,b(),l()})),t.addEventListener("click",r=>{const f=r.target.closest(".hero-content");if(f&&f.dataset.href){if(r.target.closest("a")||r.target.closest("button"))return;window.location.href=f.dataset.href}}),e.forEach((r,f)=>{r.addEventListener("click",()=>{c(),d(f)})}),n&&n.addEventListener("click",()=>{c();const r=(i-1+o.length)%o.length;d(r)}),a&&a.addEventListener("click",()=>{c();const r=(i+1)%o.length;d(r)}),l()};let deferredPrompt;const installBtnId="installAppBtn";window.addEventListener("beforeinstallprompt",t=>{console.log("PWA: beforeinstallprompt event fired"),t.preventDefault(),deferredPrompt=t,showInstallButton()});function showInstallButton(){console.log("PWA: Showing install button");let t=document.getElementById(installBtnId);t||(t=document.createElement("button"),t.id=installBtnId,t.className="install-app-btn",t.innerHTML='<i class="fas fa-download"></i> <span class="btn-text">Install App</span>',document.body.appendChild(t)),t.style.display="flex",t.style.visibility="visible",t.style.zIndex="10000",t.onclick=async()=>{if(console.log("PWA: Install button clicked"),!deferredPrompt){console.log("PWA: deferredPrompt is missing");return}deferredPrompt.prompt();const{outcome:e}=await deferredPrompt.userChoice;console.log(`PWA: User choice: ${e}`),deferredPrompt=null,t.style.display="none"}}window.addEventListener("appinstalled",()=>{const t=document.getElementById(installBtnId);t&&(t.style.display="none"),deferredPrompt=null});const initBackToTop=()=>{const t=document.getElementById("backToTop");if(!t)return;let e=!1;window.addEventListener("scroll",()=>{e||(window.requestAnimationFrame(()=>{window.scrollY>300?t.classList.add("show"):t.classList.remove("show"),e=!1}),e=!0)}),t.addEventListener("click",()=>{window.scrollTo({top:0,behavior:"smooth"})})},initSmoothScroll=()=>{document.addEventListener("click",t=>{const e=t.target.closest('a[href^="#"]');if(!e)return;const o=e.getAttribute("href");if(!(!o||o==="#"||!o.startsWith("#")))try{const n=document.querySelector(o);if(n){t.preventDefault();const s=n.getBoundingClientRect().top+window.scrollY-90;window.scrollTo({top:s,behavior:"smooth"})}}catch{}})},initGlobalSmoothScroll=()=>{document.documentElement.style.scrollBehavior="smooth"},initCelebration=()=>{if((window.location.pathname==="/"||window.location.pathname.endsWith("/index.html"))&&typeof confetti=="function"){if(sessionStorage.getItem("sjmaths_launch_celebrated"))return;sessionStorage.setItem("sjmaths_launch_celebrated","true"),window.showToast&&setTimeout(()=>window.showToast("Welcome to SJMaths! \u{1F680}","success"),500);const o=Date.now()+3e3,n=["#8e44ad","#9b59b6","#f39c12","#e74c3c","#ffffff"];(function a(){confetti({particleCount:3,angle:60,spread:55,origin:{x:0},colors:n,zIndex:10001}),confetti({particleCount:3,angle:120,spread:55,origin:{x:1},colors:n,zIndex:10001}),Date.now()<o&&requestAnimationFrame(a)})()}},initServiceWorker=()=>{"serviceWorker"in navigator&&window.addEventListener("load",()=>{navigator.serviceWorker.register("/service-worker.js").then(e=>{if(e.update(),e.waiting){showUpdateNotification(e.waiting);return}e.addEventListener("updatefound",()=>{const o=e.installing;o.addEventListener("statechange",()=>{o.state==="installed"&&navigator.serviceWorker.controller&&showUpdateNotification(o)})})}).catch(e=>console.error("Service Worker registration failed",e));let t;navigator.serviceWorker.addEventListener("controllerchange",()=>{t||(window.location.reload(),t=!0)})})};function showUpdateNotification(t){if(document.querySelector(".update-toast"))return;const e=document.createElement("div");if(e.className="update-toast",e.innerHTML=`
        <div style="display:flex; align-items:center; gap:12px;">
            <div style="background:var(--accent-purple-light, #f3e5f5); color:var(--primary); width:40px; height:40px; border-radius:50%; display:flex; align-items:center; justify-content:center; flex-shrink:0;">
                <i class="fas fa-sync-alt fa-spin"></i>
            </div>
            <div style="flex:1;">
                <div style="font-weight:600; font-size:0.9rem; color:var(--text-dark);">Update Available</div>
                <div style="font-size:0.8rem; color:var(--text-body);">New content is ready.</div>
            </div>
            <button id="reloadBtn" style="background:var(--primary); color:white; border:none; padding:8px 16px; border-radius:20px; cursor:pointer; font-weight:600; font-size:0.8rem; box-shadow: 0 2px 5px rgba(0,0,0,0.2); white-space:nowrap;">Update</button>
            <button id="dismissBtn" style="background:transparent; color:var(--text-light); border:none; cursor:pointer; font-size:1.2rem; padding:0 5px;">&times;</button>
        </div>
    `,Object.assign(e.style,{position:"fixed",bottom:"20px",right:"20px",background:"var(--bg-card, #fff)",padding:"12px 16px",borderRadius:"16px",boxShadow:"0 10px 40px rgba(0,0,0,0.15)",zIndex:"10000",fontFamily:"'Poppins', sans-serif",minWidth:"320px",border:"1px solid var(--border-color, #eee)",animation:"slideUp 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275)"}),!document.getElementById("toast-anim")){const o=document.createElement("style");o.id="toast-anim",o.innerHTML="@keyframes slideUp { from { transform: translateY(100px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }",document.head.appendChild(o)}document.body.appendChild(e);try{const o=window.AudioContext||window.webkitAudioContext;if(o){const n=new o,a=n.createOscillator(),i=n.createGain();a.connect(i),i.connect(n.destination),a.type="sine",a.frequency.setValueAtTime(523.25,n.currentTime),a.frequency.exponentialRampToValueAtTime(1046.5,n.currentTime+.1),i.gain.setValueAtTime(.1,n.currentTime),i.gain.exponentialRampToValueAtTime(.001,n.currentTime+.5),a.start(),a.stop(n.currentTime+.5)}}catch{}"vibrate"in navigator&&navigator.vibrate([200,100,200]),e.querySelector("#reloadBtn").addEventListener("click",()=>t.postMessage({type:"SKIP_WAITING"})),e.querySelector("#dismissBtn").addEventListener("click",()=>{e.style.opacity="0",e.style.transform="translateY(20px)",e.style.transition="all 0.3s ease",setTimeout(()=>e.remove(),300)})}const initNetworkStatus=()=>{const t=(e,o)=>{const n=document.createElement("div");n.className="network-toast",n.textContent=e,Object.assign(n.style,{position:"fixed",bottom:"90px",left:"50%",transform:"translateX(-50%)",background:o==="online"?"var(--secondary, #22c55e)":"#e74c3c",color:"white",padding:"8px 20px",borderRadius:"50px",zIndex:"10000",boxShadow:"0 4px 15px rgba(0,0,0,0.2)",transition:"opacity 0.5s",opacity:"0",fontSize:"0.9rem",fontWeight:"500"}),document.body.appendChild(n),requestAnimationFrame(()=>n.style.opacity="1"),setTimeout(()=>{n.style.opacity="0",setTimeout(()=>n.remove(),500)},3e3)};window.addEventListener("online",()=>t("You are back online!","online")),window.addEventListener("offline",()=>t("You are offline. Some features may be unavailable.","offline"))};window.showToast=function(t,e="info"){const o=document.createElement("div");if(o.innerHTML=t,o.style.cssText=`
      position: fixed;
      bottom: 30px;
      left: 50%;
      transform: translateX(-50%);
      background: ${e==="error"?"#e74c3c":e==="success"?"#2ecc71":"#333"};
      color: white;
      padding: 12px 24px;
      border-radius: 50px;
      z-index: 10000;
      font-family: Poppins, sans-serif;
      font-size: 14px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.2);
      animation: fadeInToast 0.3s ease forwards;
    `,!document.getElementById("toast-style-global")){const n=document.createElement("style");n.id="toast-style-global",n.innerHTML="@keyframes fadeInToast { from { opacity: 0; transform: translate(-50%, 20px); } to { opacity: 1; transform: translate(-50%, 0); } }",document.head.appendChild(n)}document.body.appendChild(o),setTimeout(()=>{o.style.opacity="0",o.style.transition="opacity 0.3s ease",setTimeout(()=>o.remove(),300)},3e3)};const initSharedUI=async()=>{const e=(()=>{const p=window.location.pathname,l=p.split("/").filter(Boolean);return l.length>0&&(l[l.length-1].includes(".")||p.endsWith("/"))&&l.pop(),"../".repeat(l.length)||"./"})(),o=document.getElementById("footer-year");o&&(o.textContent=new Date().getFullYear());const n=p=>p.replace("/index.html","/").replace(/\/$/,"")||"/",a=n(window.location.pathname);document.querySelectorAll("nav a").forEach(p=>{try{const l=new URL(p.href,window.location.origin).pathname,c=n(l);(a===c||c!=="/"&&a.startsWith(c))&&p.classList.add("active")}catch{}});const i=async()=>{try{const{onAuthStateChanged:p,signOut:l}=await import("https://www.gstatic.com/firebasejs/12.8.0/firebase-auth.js"),{auth:c}=await import(e+"assets/js/firebase-config.js");p(c,u=>{const h=document.getElementById("authBtn"),b=document.getElementById("headerProfileBtn");if(u){if(b)return;const m=u.displayName||"Student",r=u.photoURL||`https://ui-avatars.com/api/?name=${encodeURIComponent(m)}&background=random&color=fff`,f=`
                    <div style="display: flex; align-items: center; gap: 1rem;">
                        <a href="${e}notifications.html" id="headerNotificationBtn" title="Notifications" style="background: none; border: none; cursor: pointer; position: relative; color: var(--text-dark);">
                            <i class="fas fa-bell" style="font-size: 1.2rem;"></i>
                            <span id="notification-badge" style="display: none; position: absolute; top: -5px; right: -5px; background: var(--secondary); color: white; border-radius: 50%; width: 18px; height: 18px; font-size: 0.7rem; font-weight: bold; line-height: 18px; text-align: center; border: 1px solid white;"></span>
                        </a>
                        <div class="profile-dropdown-wrapper" style="position: relative; display: inline-block;">
                            <button id="headerProfileBtn" style="background: none; border: none; cursor: pointer; padding: 0; display: flex; align-items: center;">
                                <img src="${r}" alt="Profile" style="width: 38px; height: 38px; border-radius: 50%; object-fit: cover; border: 2px solid var(--primary); box-shadow: 0 2px 5px rgba(0,0,0,0.1);">
                            </button>
                            <div id="headerProfileDropdown" style="display: none; position: absolute; right: 0; top: 120%; background: white; min-width: 220px; border-radius: 12px; box-shadow: 0 10px 40px rgba(0,0,0,0.15); padding: 10px; z-index: 10000; border: 1px solid rgba(0,0,0,0.05);">
                                <div style="padding: 10px 15px; border-bottom: 1px solid #eee; margin-bottom: 5px;">
                                    <div style="font-weight: 700; color: var(--text-dark);">${m}</div>
                                    <div style="font-size: 0.8rem; color: var(--text-light); white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${u.email}</div>
                                </div>
                                <a href="${e}dashboard.html" style="display: flex; align-items: center; gap: 10px; padding: 10px 15px; color: var(--text-dark); text-decoration: none; border-radius: 8px; transition: background 0.2s;">
                                    <i class="fas fa-th-large" style="color: var(--primary); width: 20px;"></i> Dashboard
                                </a>
                                <a href="${e}profile.html" style="display: flex; align-items: center; gap: 10px; padding: 10px 15px; color: var(--text-dark); text-decoration: none; border-radius: 8px; transition: background 0.2s;">
                                    <i class="fas fa-user" style="color: var(--primary); width: 20px;"></i> My Profile
                                </a>
                                <a href="${e}settings.html" style="display: flex; align-items: center; gap: 10px; padding: 10px 15px; color: var(--text-dark); text-decoration: none; border-radius: 8px; transition: background 0.2s;">
                                    <i class="fas fa-cog" style="color: var(--primary); width: 20px;"></i> Settings
                                </a>
                                <div style="border-top: 1px solid #eee; margin: 5px 0;"></div>
                                <button id="headerLogoutBtn" style="width: 100%; text-align: left; background: none; border: none; padding: 10px 15px; color: var(--secondary); cursor: pointer; border-radius: 8px; display: flex; align-items: center; gap: 10px; font-size: 0.95rem; font-family: inherit;">
                                    <i class="fas fa-sign-out-alt" style="width: 20px;"></i> Logout
                                </button>
                            </div>
                        </div>
                    </div>
                `;if(h){const g=document.createElement("div");g.innerHTML=f,h.replaceWith(g.firstElementChild)}const x=document.getElementById("headerProfileBtn"),y=document.getElementById("headerProfileDropdown"),v=document.getElementById("headerLogoutBtn");x&&y&&(x.addEventListener("click",g=>{g.stopPropagation(),y.style.display=y.style.display==="block"?"none":"block"}),document.addEventListener("click",g=>{y.style.display==="block"&&!y.contains(g.target)&&!x.contains(g.target)&&(y.style.display="none")})),v&&v.addEventListener("click",async()=>{await l(c),window.location.href=`${e}login.html`})}else if(b){const m=document.createElement("a");m.href=`${e}login.html`,m.className="auth-btn-pill",m.id="authBtn",m.textContent="Login",b.closest(".profile-dropdown-wrapper").parentElement.replaceWith(m)}})}catch{}};"requestIdleCallback"in window?requestIdleCallback(i,{timeout:3e3}):setTimeout(i,2e3);const s=document.querySelector(".mobile-toggle"),d=document.querySelector(".desktop-nav")||document.querySelector("nav");s&&d&&s.addEventListener("click",p=>{p.stopPropagation();const l=d.classList.toggle("active"),c=s.querySelector("i");c&&(c.className=l?"fas fa-times":"fas fa-bars")})};document.addEventListener("DOMContentLoaded",()=>{initDarkMode(),initScrollAnimations(),initParallax(),initHeroSlider(),initBackToTop(),initSmoothScroll(),initGlobalSmoothScroll(),initCelebration(),initNetworkStatus(),initSharedUI()}),initServiceWorker();
