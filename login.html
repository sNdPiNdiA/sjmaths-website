<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Login - SJMaths</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" type="image/svg+xml" href="assets/favicon.svg">
  <link rel="stylesheet" href="assets/css/hero.css">
  <link rel="stylesheet" href="assets/css/auth.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>

<div class="login-container">
  <a href="index.html" class="logo"><span class="logo-symbol">&int;</span> SJMaths</a>

  <h2>Welcome</h2>
  <p class="subtitle">Login or create your account</p>

  <form id="loginForm">
    <div class="input-group">
      <label>Email Address</label>
      <input type="email" id="email" placeholder="student@example.com" required>
    </div>

    <div class="input-group">
      <label>Password</label>
      <input type="password" id="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" required>
    </div>

    <div class="checkbox-group">
      <input type="checkbox" id="rememberMe" checked>
      <label for="rememberMe">Remember Me</label>
    </div>

    <button class="login-btn" type="submit">Sign In</button>

    <button type="button" class="google-btn" id="googleLoginBtn">
      <i class="fab fa-google"></i> Sign in with Google
    </button>

    <div class="links space-between">
  <a href="#" id="forgotPassword">Forgot Password?</a>
  <a href="signup.html" id="signupLink">Create Account</a>
  <a href="#" id="resendVerification" style="display:none;">Resend verification email</a>
</div>

  </form>

  <a href="index.html" class="back-home">
    <i class="fas fa-arrow-left"></i> Back to Home
  </a>
</div>

<script type="module">
import {
  signInWithEmailAndPassword,
  sendPasswordResetEmail,
  setPersistence,
  browserLocalPersistence,
  browserSessionPersistence,
  GoogleAuthProvider,
  signInWithPopup,
  sendEmailVerification
} from "https://www.gstatic.com/firebasejs/12.8.0/firebase-auth.js";

import { auth, analytics, logEvent } from './assets/js/firebase-config.js';
import { showToast } from './assets/js/auth.js';

const emailInput = document.getElementById("email");
const passwordInput = document.getElementById("password");
const signupLink = document.getElementById("signupLink");
const resendLink = document.getElementById("resendVerification");
const forgotLink = document.getElementById("forgotPassword");

/* LOGIN */
document.getElementById("loginForm").addEventListener("submit", async (e) => {
  e.preventDefault();
  const btn = document.querySelector(".login-btn");
  btn.innerText = "Signing in...";
  btn.disabled = true;

  try {
    const rememberMe = document.getElementById("rememberMe").checked;
    await setPersistence(auth, rememberMe ? browserLocalPersistence : browserSessionPersistence);

    const userCredential = await signInWithEmailAndPassword(auth, emailInput.value, passwordInput.value);
    const user = userCredential.user;

    if (!user.emailVerified) {
      showToast("Please verify your email before logging in.", "error");
      resendLink.style.display = "inline";
      await auth.signOut();
      btn.innerText = "Sign In";
      btn.disabled = false;
      return;
    }

    window.location.href = "profile.html";
  } catch (error) {
    showToast(error.message, "error");
    btn.innerText = "Sign In";
    btn.disabled = false;
  }
});

/* GOOGLE LOGIN */
document.getElementById("googleLoginBtn").addEventListener("click", async () => {
  try {
    const provider = new GoogleAuthProvider();
    await signInWithPopup(auth, provider);
    window.location.href = "profile.html";
  } catch (error) {
    showToast(error.message, "error");
  }
});

/* FORGOT PASSWORD */
forgotLink.addEventListener("click", async (e) => {
  e.preventDefault();
  if (!emailInput.value) {
    showToast("Enter your email first.", "error");
    return;
  }
  try {
    await sendPasswordResetEmail(auth, emailInput.value);
    showToast("Password reset email sent.", "success");
  } catch (error) {
    showToast(error.message, "error");
  }
});

/* RESEND VERIFICATION */
resendLink.addEventListener("click", async (e) => {
  e.preventDefault();

  if (!emailInput.value || !passwordInput.value) {
    showToast("Enter email and password first.", "error");
    return;
  }

  try {
    const userCredential = await signInWithEmailAndPassword(auth, emailInput.value, passwordInput.value);
const user = userCredential.user;

// ðŸ”„ Refresh from Firebase server
await user.reload();

if (user.emailVerified) {
  showToast("Your email is already verified.", "success");
  return;
}

await sendEmailVerification(user);
showToast("Verification email resent. Check Inbox or Spam.", "success");
await auth.signOut();

  } catch (error) {
    showToast(error.message, "error");
  }
});

logEvent(analytics, "page_view", {
  page_title: document.title,
  page_path: window.location.pathname
});
</script>

</body>
</html>
