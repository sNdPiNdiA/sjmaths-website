<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>My Profile - SJMaths</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/svg+xml" href="assets/favicon.svg">
    <link rel="stylesheet" href="assets/css/main.css">
    <link rel="stylesheet" href="assets/css/layout.css">
    <link rel="stylesheet" href="assets/css/component.css">
    <link rel="stylesheet" href="assets/css/dashboard.css">
</head>

<body>
<div id="header-container"></div>

<main>
  <div class="profile-container">
    <div class="profile-header">
      <img id="avatarDisplay" class="profile-avatar">
      <div class="profile-info">
        <h1 id="nameDisplay">Loading...</h1>
        <p id="emailDisplay">...</p>
      </div>
    </div>

    <form id="profileForm">
      <div class="form-group">
        <label>Full Name</label>
        <input type="text" id="displayNameInput">
      </div>

      <div class="form-group">
        <label>Email</label>
        <input type="email" id="emailInput" readonly>
      </div>

      <div class="form-group">
        <label>Profile Picture URL</label>
        <input type="url" id="photoUrlInput">
      </div>

      <div class="form-group">
        <label>Class</label>
        <select id="classSelect">
          <option value="">Select Class</option>
          <option value="9">Class 9</option>
          <option value="10">Class 10</option>
          <option value="11">Class 11</option>
          <option value="12">Class 12</option>
        </select>
      </div>

      <button type="submit" class="btn-save">Save Profile</button>
    </form>
    <button id="logoutBtn" class="btn-save" style="background-color: var(--secondary); margin-top: 15px;">Logout</button>
  </div>
</main>

<div id="footer-container"></div>

<script type="module">
    import { initSharedHeader } from './shared-header.js';
    initSharedHeader(null, './');
</script>
<script src="assets/js/main.js" defer></script>

<script type="module">
import { onAuthStateChanged, updateProfile, signOut } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-auth.js";
import { doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore.js";

import { auth, db, analytics, logEvent } from './assets/js/firebase-config.js';
import { showToast } from './assets/js/auth.js';

// DOM
const avatarDisplay = document.getElementById('avatarDisplay');
const nameDisplay = document.getElementById('nameDisplay');
const emailDisplay = document.getElementById('emailDisplay');
const displayNameInput = document.getElementById('displayNameInput');
const emailInput = document.getElementById('emailInput');
const photoUrlInput = document.getElementById('photoUrlInput');
const classSelect = document.getElementById('classSelect');
const profileForm = document.getElementById('profileForm');
const logoutBtn = document.getElementById('logoutBtn');

// Load user
onAuthStateChanged(auth, async (user) => {
  if (!user) {
    return;
  }

  const name = user.displayName || "Student";
  const photo = user.photoURL || `https://ui-avatars.com/api/?name=${encodeURIComponent(name)}&background=random&color=fff`;

  avatarDisplay.src = photo;
  nameDisplay.textContent = name;
  emailDisplay.textContent = user.email;
  displayNameInput.value = name;
  emailInput.value = user.email;
  photoUrlInput.value = user.photoURL || "";

  const snap = await getDoc(doc(db, "users", user.uid));
  if (snap.exists() && snap.data().class) {
    classSelect.value = snap.data().class;
  }
});

// Save
profileForm.addEventListener("submit", async (e) => {
  e.preventDefault();
  const user = auth.currentUser;
  if (!user) return;

  const newName = displayNameInput.value || "Student";
  const newPhoto = photoUrlInput.value;
  const userClass = classSelect.value;

  try {
    await updateProfile(user, {
      displayName: newName,
      photoURL: newPhoto || null
    });

    await setDoc(doc(db, "users", user.uid), {
      name: newName,
      email: user.email,
      photoURL: newPhoto || null,
      class: userClass,
      role: "student",
      updatedAt: new Date()
    }, { merge: true });

    logEvent(analytics, "profile_updated");
    showToast("Profile updated successfully", "success");
  } catch (err) {
    showToast(err.message, "error");
  }
});

// Logout
logoutBtn.addEventListener("click", async () => {
  try {
    await signOut(auth);
    window.location.href = "login.html";
  } catch (error) {
    showToast(error.message, "error");
  }
});
</script>

<script type="module">
  import { analytics, logEvent } from "./assets/js/firebase-config.js";

  logEvent(analytics, "page_view", {
    page_title: document.title,
    page_path: window.location.pathname
  });

</script>

</body>
</html>
