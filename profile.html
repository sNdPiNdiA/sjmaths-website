<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>My Profile - SJMaths</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/svg+xml" href="assets/favicon.svg">
    <link rel="stylesheet" href="assets/css/main.css">
    <link rel="stylesheet" href="assets/css/layout.css">
    <link rel="stylesheet" href="assets/css/component.css">
    <link rel="stylesheet" href="assets/css/dashboard.css">
    <style>
        /* CEO/CTO Level Polish */
        :root {
            --glass-bg: rgba(255, 255, 255, 0.95);
            --glass-border: rgba(255, 255, 255, 0.2);
            --shadow-lg: 0 10px 30px -5px rgba(0, 0, 0, 0.1);
        }

        body.dark-mode {
            --glass-bg: rgba(30, 30, 30, 0.95);
            --glass-border: rgba(255, 255, 255, 0.05);
        }

        .profile-container {
            max-width: 800px;
            margin: 2rem auto;
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border);
            border-radius: 1.5rem;
            box-shadow: var(--shadow-lg);
            padding: 3rem;
            animation: fadeIn 0.5s ease-out;
        }

        .profile-header {
            display: flex;
            align-items: center;
            gap: 2rem;
            margin-bottom: 3rem;
            padding-bottom: 2rem;
            border-bottom: 1px solid var(--border-color, #eee);
        }

        .profile-avatar {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            object-fit: cover;
            border: 4px solid var(--primary);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .profile-info h1 { margin: 0; font-size: 2rem; letter-spacing: -0.5px; }
        .profile-info p { margin: 0.5rem 0 0; opacity: 0.7; }

        .profile-meta {
            display: flex;
            gap: 1.5rem;
            margin-top: 1rem;
            font-size: 0.85rem;
            color: var(--text-light);
        }
        .profile-meta span { display: flex; align-items: center; gap: 6px; }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
        }

        .btn-group {
            margin-top: 2rem;
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
        }

        textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border-color, #ddd);
            border-radius: 10px;
            background: rgba(255,255,255,0.5);
            font-family: inherit;
            resize: vertical;
        }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .skeleton { background: #e0e0e0; color: transparent; border-radius: 4px; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { opacity: 0.6; } 50% { opacity: 1; } 100% { opacity: 0.6; } }
    </style>
</head>

<body>
<div id="header-container"></div>

<main>
  <div class="profile-container">
    <div class="profile-header">
      <img id="avatarDisplay" class="profile-avatar skeleton" alt="Profile Avatar">
      <div class="profile-info">
        <h1 id="nameDisplay" class="skeleton">Loading User...</h1>
        <p id="emailDisplay" class="skeleton">loading@example.com</p>
        <div class="profile-meta">
            <span id="joinedDisplay"><i class="fas fa-calendar-alt"></i> Joined: ...</span>
            <span id="lastLoginDisplay"><i class="fas fa-clock"></i> Last Login: ...</span>
        </div>
      </div>
    </div>

    <form id="profileForm">
      <div class="form-grid">
        <div class="form-group">
          <label for="displayNameInput">Full Name</label>
          <input type="text" id="displayNameInput" placeholder="Enter your full name" required>
        </div>

        <div class="form-group">
          <label for="emailInput">Email Address</label>
          <input type="email" id="emailInput" readonly style="cursor: not-allowed; opacity: 0.7;">
        </div>

        <div class="form-group">
          <label for="photoUrlInput">Profile Picture URL</label>
          <input type="url" id="photoUrlInput" placeholder="https://example.com/avatar.jpg">
        </div>

        <div class="form-group">
          <label for="classSelect">Class / Grade</label>
          <select id="classSelect">
            <option value="">Select Class</option>
            <option value="9">Class 9</option>
            <option value="10">Class 10</option>
            <option value="11">Class 11</option>
            <option value="12">Class 12</option>
          </select>
        </div>

        <div class="form-group" style="grid-column: 1 / -1;">
            <label for="bioInput">Bio</label>
            <textarea id="bioInput" rows="3" placeholder="Tell us a bit about yourself..."></textarea>
        </div>
      </div>

      <div class="btn-group">
        <button type="button" id="logoutBtn" class="btn-save" style="background-color: var(--secondary); border: none;">
            <i class="fas fa-sign-out-alt"></i> Logout
        </button>
        <button type="submit" id="saveBtn" class="btn-save">
            <i class="fas fa-save"></i> Save Changes
        </button>
      </div>
    </form>
  </div>
</main>

<div id="footer-container"></div>

<script type="module">
    import { initSharedHeader } from './shared-header.js';
    initSharedHeader(null, './');
</script>
<script src="assets/js/main.js" defer></script>

<script type="module">
import { onAuthStateChanged, updateProfile, signOut } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-auth.js";
import { doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore.js";

import { auth, db, analytics, logEvent } from './assets/js/firebase-config.js';
import { showToast } from './assets/js/utils.js';

// DOM
const avatarDisplay = document.getElementById('avatarDisplay');
const nameDisplay = document.getElementById('nameDisplay');
const emailDisplay = document.getElementById('emailDisplay');
const displayNameInput = document.getElementById('displayNameInput');
const emailInput = document.getElementById('emailInput');
const photoUrlInput = document.getElementById('photoUrlInput');
const classSelect = document.getElementById('classSelect');
const bioInput = document.getElementById('bioInput');
const joinedDisplay = document.getElementById('joinedDisplay');
const lastLoginDisplay = document.getElementById('lastLoginDisplay');
const profileForm = document.getElementById('profileForm');
const logoutBtn = document.getElementById('logoutBtn');
const saveBtn = document.getElementById('saveBtn');

// Load user
onAuthStateChanged(auth, async (user) => {
  if (!user) {
    window.location.href = "login.html"; // Enforce auth
    return;
  }

  const name = user.displayName || "Student";
  const photo = user.photoURL || `https://ui-avatars.com/api/?name=${encodeURIComponent(name)}&background=random&color=fff`;

  avatarDisplay.src = photo;
  avatarDisplay.classList.remove('skeleton');
  
  nameDisplay.classList.remove('skeleton');
  nameDisplay.textContent = name;
  
  emailDisplay.classList.remove('skeleton');
  emailDisplay.textContent = user.email;
  
  displayNameInput.value = name;
  emailInput.value = user.email;
  photoUrlInput.value = user.photoURL || "";

  // Metadata
  if (user.metadata) {
      joinedDisplay.innerHTML = `<i class="fas fa-calendar-alt"></i> Joined: ${new Date(user.metadata.creationTime).toLocaleDateString()}`;
      lastLoginDisplay.innerHTML = `<i class="fas fa-clock"></i> Last Login: ${new Date(user.metadata.lastSignInTime).toLocaleDateString()}`;
  }

  const snap = await getDoc(doc(db, "users", user.uid));
  if (snap.exists()) {
      const data = snap.data();
      if (data.class) classSelect.value = data.class;
      if (data.bio) bioInput.value = data.bio;
  }

  logEvent(analytics, "page_view", { page_title: "Profile", page_path: "/profile.html" });
});

// Save
profileForm.addEventListener("submit", async (e) => {
  e.preventDefault();
  const user = auth.currentUser;
  if (!user) return;

  // UI Loading State
  const originalBtnText = saveBtn.innerHTML;
  saveBtn.disabled = true;
  saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';

  const newName = displayNameInput.value || "Student";
  const newPhoto = photoUrlInput.value;
  const userClass = classSelect.value;
  const userBio = bioInput.value;

  try {
    await updateProfile(user, {
      displayName: newName,
      photoURL: newPhoto || null
    });

    // Update UI immediately
    nameDisplay.textContent = newName;
    if (newPhoto) avatarDisplay.src = newPhoto;

    // Sync with Firestore
    await setDoc(doc(db, "users", user.uid), {
      name: newName,
      email: user.email,
      photoURL: newPhoto || null,
      class: userClass,
      role: "student",
      bio: userBio,
      updatedAt: new Date()
    }, { merge: true });

    logEvent(analytics, "profile_updated");
    showToast("Profile updated successfully", "success");
  } catch (err) {
    showToast(err.message, "error");
  } finally {
    saveBtn.disabled = false;
    saveBtn.innerHTML = originalBtnText;
  }
});

// Logout
logoutBtn.addEventListener("click", async () => {
  try {
    await signOut(auth);
    window.location.href = "login.html";
  } catch (error) {
    showToast(error.message, "error");
  }
});
</script>

</body>
</html>
